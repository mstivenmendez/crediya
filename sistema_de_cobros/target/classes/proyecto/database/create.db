-- MySQL Workbench Forward Engineering

SET @OLD_UNIQUE_CHECKS=@@UNIQUE_CHECKS, UNIQUE_CHECKS=0;
SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0;
SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE='ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION';

-- -----------------------------------------------------
-- Schema mydb
-- -----------------------------------------------------
-- -----------------------------------------------------
-- Schema crediya_db
-- -----------------------------------------------------

-- -----------------------------------------------------
-- Schema crediya_db
-- -----------------------------------------------------
CREATE SCHEMA IF NOT EXISTS crediya_db DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci ;
USE crediya_db ;

-- -----------------------------------------------------
-- Table crediya_db.usuario
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS crediya_db.usuario (
  usuario_id INT NOT NULL AUTO_INCREMENT,
  correo VARCHAR(80) NOT NULL,
  clave VARCHAR(45) NULL DEFAULT NULL,
  estado ENUM('activo', 'inactivo') NULL DEFAULT NULL,
  fecha_creacion DATETIME NULL DEFAULT NULL,
  PRIMARY KEY (usuario_id))
ENGINE = InnoDB
DEFAULT CHARACTER SET = utf8mb4
COLLATE = utf8mb4_0900_ai_ci;


-- -----------------------------------------------------
-- Table crediya_db.informacion
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS crediya_db.informacion (
  usuario_id_fk INT NOT NULL AUTO_INCREMENT,
  primer_nombre VARCHAR(45) NOT NULL,
  segundo_nombre VARCHAR(45) NULL DEFAULT NULL,
  primer_apellido VARCHAR(45) NOT NULL,
  segundo_apellido VARCHAR(45) NULL DEFAULT NULL,
  documento VARCHAR(45) NOT NULL,
  telefono VARCHAR(45) NULL DEFAULT NULL,
  salario DECIMAL(10,2) NULL,
  PRIMARY KEY (usuario_id_fk),
  INDEX fk_empleado_usuario1_idx (usuario_id_fk ASC) VISIBLE,
  CONSTRAINT fk_empleado_usuario1
    FOREIGN KEY (usuario_id_fk)
    REFERENCES crediya_db.usuario (usuario_id))
ENGINE = InnoDB
DEFAULT CHARACTER SET = utf8mb4
COLLATE = utf8mb4_0900_ai_ci;


-- -----------------------------------------------------
-- Table crediya_db.prestamo
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS crediya_db.prestamo (
  prestamo_id INT NOT NULL,
  cliente_usuario_id_fk INT NOT NULL,
  empleado_usuario_id_fk INT NOT NULL,
  valor DECIMAL(12,2) NOT NULL,
  interes DECIMAL(10,2) NOT NULL,
  cuotas INT NOT NULL,
  fecha_inicio DATETIME NOT NULL,
  fecha_limite DATETIME NOT NULL,
  estado ENUM('activo','inactivo') NOT NULL,
  PRIMARY KEY (prestamo_id),
  UNIQUE INDEX prestamo_id_UNIQUE (prestamo_id ASC) VISIBLE,
  INDEX fk_prestamo_usuario1_idx (empleado_usuario_id_fk ASC) VISIBLE,
  INDEX fk_prestamo_usuario2_idx (cliente_usuario_id_fk ASC) VISIBLE,
  CONSTRAINT fk_prestamo_usuario1
    FOREIGN KEY (empleado_usuario_id_fk)
    REFERENCES crediya_db.usuario (usuario_id)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION,
  CONSTRAINT fk_prestamo_usuario2
    FOREIGN KEY (cliente_usuario_id_fk)
    REFERENCES crediya_db.usuario (usuario_id)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION)
ENGINE = InnoDB
DEFAULT CHARACTER SET = utf8mb4
COLLATE = utf8mb4_0900_ai_ci;


-- -----------------------------------------------------
-- Table crediya_db.rol
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS crediya_db.rol (
  rol_id INT NOT NULL,
  nombre VARCHAR(45) NOT NULL,
  PRIMARY KEY (rol_id))
ENGINE = InnoDB;


-- -----------------------------------------------------
-- Table crediya_db.usuario_rol
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS crediya_db.usuario_rol (
  usuario_id_fk INT NOT NULL,
  rol_id_fk INT NOT NULL,
  PRIMARY KEY (usuario_id_fk, rol_id_fk),
  INDEX fk_usuario_has_rol_rol1_idx (rol_id_fk ASC) VISIBLE,
  INDEX fk_usuario_has_rol_usuario1_idx (usuario_id_fk ASC) VISIBLE,
  CONSTRAINT fk_usuario_has_rol_usuario1
    FOREIGN KEY (usuario_id_fk)
    REFERENCES crediya_db.usuario (usuario_id)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION,
  CONSTRAINT fk_usuario_has_rol_rol1
    FOREIGN KEY (rol_id_fk)
    REFERENCES crediya_db.rol (rol_id)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION)
ENGINE = InnoDB
DEFAULT CHARACTER SET = utf8mb4
COLLATE = utf8mb4_0900_ai_ci;


-- -----------------------------------------------------
-- Table crediya_db.pago
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS crediya_db.pago (
  pago_id INT NOT NULL,
  prestamo_id_fk INT NOT NULL,
  valor DECIMAL(12,2) NOT NULL,
  fecha_pago DATETIME NULL,
  estado ENUM('pendiente', 'pagado', 'vencido') NOT NULL,
  PRIMARY KEY (pago_id),
  INDEX fk_pago_prestamo1_idx (prestamo_id_fk ASC) VISIBLE,
  CONSTRAINT fk_pago_prestamo1
    FOREIGN KEY (prestamo_id_fk)
    REFERENCES crediya_db.prestamo (prestamo_id)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION)
ENGINE = InnoDB;


SET SQL_MODE=@OLD_SQL_MODE;
SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS;
SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS;



//// inserts

-- Insertar roles básicos en la tabla rol
-- Ejecutar este script DESPUÉS de crear la base de datos

USE crediya_db;

-- Limpiar tabla de roles si existe data previa (opcional)
-- DELETE FROM rol;

-- Insertar roles básicos
INSERT INTO rol (rol_id, nombre) VALUES
(1, 'Administrador'),
(2, 'Cliente'),
(3, 'Empleado');

-- Verificar que se insertaron correctamente
SELECT * FROM rol;

-- (OPCIONAL) Crear un usuario administrador de prueba
-- Contraseña: Admin123! (ajusta según tus necesidades)
INSERT INTO usuario (correo, clave, estado, fecha_creacion) 
VALUES ('admin@crediya.com', 'Admin123!', 'activo', NOW());

-- Obtener el ID del usuario recién creado
SET @admin_usuario_id = LAST_INSERT_ID();

-- Insertar información del administrador
INSERT INTO informacion (usuario_id_fk, primer_nombre, segundo_nombre, primer_apellido, segundo_apellido, documento, telefono, salario)
VALUES (@admin_usuario_id, 'Admin', NULL, 'Sistema', NULL, '0000000000', '0000000000', NULL);

-- Asignar rol de administrador
INSERT INTO usuario_rol (usuario_id_fk, rol_id_fk)
VALUES (@admin_usuario_id, 1);

-- Verificar el usuario administrador
SELECT 
    u.usuario_id,
    u.correo,
    u.estado,
    i.primer_nombre,
    i.primer_apellido,
    r.nombre as rol
FROM usuario u
INNER JOIN informacion i ON u.usuario_id = i.usuario_id_fk
INNER JOIN usuario_rol ur ON u.usuario_id = ur.usuario_id_fk
INNER JOIN rol r ON ur.rol_id_fk = r.rol_id
WHERE u.correo = 'admin@crediya.com';

-- Consultas útiles para verificar la estructura

-- Ver todos los usuarios con sus roles
SELECT 
    u.usuario_id,
    u.correo,
    u.estado,
    i.primer_nombre,
    i.primer_apellido,
    i.documento,
    r.nombre as rol
FROM usuario u
INNER JOIN informacion i ON u.usuario_id = i.usuario_id_fk
INNER JOIN usuario_rol ur ON u.usuario_id = ur.usuario_id_fk
INNER JOIN rol r ON ur.rol_id_fk = r.rol_id
ORDER BY u.usuario_id;

-- Ver solo clientes
SELECT 
    u.usuario_id,
    u.correo,
    u.estado,
    i.primer_nombre,
    i.primer_apellido,
    i.documento,
    i.telefono
FROM usuario u
INNER JOIN informacion i ON u.usuario_id = i.usuario_id_fk
INNER JOIN usuario_rol ur ON u.usuario_id = ur.usuario_id_fk
WHERE ur.rol_id_fk = 2
ORDER BY u.usuario_id;

-- Contar usuarios por rol
SELECT 
    r.nombre as rol,
    COUNT(*) as cantidad
FROM usuario_rol ur
INNER JOIN rol r ON ur.rol_id_fk = r.rol_id
GROUP BY r.nombre;